Tarefa 02: Refatorar Faturas e Boletos (Método Alternativo)
Objetivo: Modificar os serviços de faturas para usar o endpoint /fn_areceber (listar faturas) e /get_boleto (buscar boleto), utilizando o id_cliente (obtido no login) como filtro.

Contexto: Esta tarefa é uma continuação da refatoração do "Método Alternativo". Ela assume que o AuthContext já armazena o id_cliente e que o ixcApi.ts será modificado para suportar o header ixcsoft: listar.

1. Modificação em constants/config.ts
Primeiro, precisamos de adicionar os novos endpoints (fn_areceber e get_boleto) ao nosso ficheiro de configuração.

TypeScript

// Em: constants/config.ts

export const IXC_CONFIG = {
  BASE_URL: 'https://centralfiber.online/webservice/v1',
  TOKEN: 'SEU_TOKEN_DE_ADMIN_AQUI', // O token da imagem (Carlos Eduardo)
  
  ENDPOINTS: {
    // LOGIN: '/login', // Não usado
    CLIENTE: '/cliente', 
    CONTRATO: '/cliente_contrato',
    
    // NOVOS ENDPOINTS
    FN_ARECEBER: '/fn_areceber', // Para listar faturas
    GET_BOLETO: '/get_boleto'   // Para buscar o boleto
  }
};

// ... (Resto do arquivo, GENIE_ACS_CONFIG, etc.)
2. Modificação em types/ixc.ts
Precisamos de tipos para a resposta das faturas e para o pedido do boleto.

TypeScript

// Em: types/ixc.ts

// (Manter os tipos existentes: IXCLoginRequest, AuthUserData, etc...)

// Novo Tipo para a resposta de /fn_areceber
export interface IXCFatura {
  id: string;
  id_cliente: string;
  data_vencimento: string;
  valor: string;
  status: 'A' | 'B'; // A = Aberto, B = Baixado
  linha_digitavel: string;
  // ... adicione outros campos que o /fn_areceber retornar
}

export interface IXCFaturaResponse {
  total: number;
  registros: IXCFatura[];
}

// Novo Tipo para o pedido /get_boleto
export interface IXCBoletoRequest {
  boletos: string; // ID da fatura (campo 'id' do fn_areceber)
  juro?: 'S' | 'N';
  multa?: 'S' | 'N';
  atualiza_boleto: 'S';
  tipo_boleto: 'arquivo';
  base64: 'S';
}

// Novo Tipo para a resposta /get_boleto
export interface IXCBoletoResponse {
  file: string; // O boleto em base64
  // ... outros campos se houver
}
3. Modificação em services/ixcApi.ts
Este ficheiro precisa de ser alterado (como discutimos na tarefa anterior) para suportar os dois tipos de chamadas:

POST normal: Para o /get_boleto.

POST com ixcsoft: listar: Para o /fn_areceber.

TypeScript

// Em: services/ixcApi.ts
import axios, { AxiosInstance, AxiosRequestConfig } from 'axios';
import { IXC_CONFIG } from '@/constants/config';
import base64 from 'react-native-base64'; // Instale: pnpm add react-native-base64

class IXCApiClient {
  private api: AxiosInstance;
  private adminToken: string;

  constructor() {
    this.adminToken = this.encodeToken(IXC_CONFIG.TOKEN);

    this.api = axios.create({
      baseURL: IXC_CONFIG.BASE_URL,
      headers: {
        'Content-Type': 'application/json',
        // O Token de Admin é o padrão para TODAS as requisições
        'Authorization': this.adminToken, 
      },
      timeout: 10000,
    });
  }

  // Codifica o Token de Admin (Formato: ID_USUARIO:TOKEN)
  private encodeToken(tokenWithId: string): string {
    try {
      // Assumindo que o TOKEN no config.ts está "ID:TOKEN_STRING"
      return `Basic ${base64.encode(tokenWithId)}`;
    } catch (e) {
      console.error("Falha ao codificar token.", e);
      return `Basic ${tokenWithId}`;
    }
  }

  // POST Padrão (para Criar/Editar/Get_Boleto)
  public async post<T = any>(endpoint: string, data: any): Promise<T> {
    const response = await this.api.post(endpoint, data);
    return response.data;
  }

  // POST para Listar/Pesquisar (com o header 'listar')
  public async postList<T = any>(endpoint: string, data: any): Promise<T> {
    const config: AxiosRequestConfig = {
      headers: {
        'ixcsoft': 'listar' // Header especial para pesquisa
      }
    };
    const response = await this.api.post(endpoint, data, config);
    return response.data;
  }
}

export const ixcApi = new IXCApiClient();
4. Modificação em services/invoiceService.ts
Este é o ficheiro principal da tarefa. Vamos reescrevê-lo para usar o id_cliente e os novos endpoints.

TypeScript

// Em: services/invoiceService.ts
import { ixcApi } from './ixcApi';
import { IXC_CONFIG } from '@/constants/config';
import type { 
  IXCFatura,
  IXCFaturaResponse, 
  IXCBoletoRequest,
  IXCBoletoResponse
} from '@/types/ixc';

export const invoiceService = {

  /**
   * Busca as faturas (em aberto e pagas) de um cliente específico.
   * (Método Alternativo: usa /fn_areceber com id_cliente)
   */
  async getInvoices(idCliente: string): Promise<IXCFatura[]> {
    try {
      // 1. Prepara o corpo da requisição (JSON do seu cURL)
      const requestBody = {
        qtype: 'fn_areceber.id_cliente',
        query: idCliente, // Filtra pelo ID do cliente logado
        oper: '=',
        page: '1',
        rp: '50', // Pega as últimas 50 faturas
        sortname: 'fn_areceber.data_vencimento',
        sortorder: 'desc',
      };

      // 2. Chama o 'postList' (com header 'ixcsoft: listar')
      const response = await ixcApi.postList<IXCFaturaResponse>(
        IXC_CONFIG.ENDPOINTS.FN_ARECEBER,
        requestBody
      );

      if (response.total > 0) {
        return response.registros;
      }
      
      return []; // Retorna lista vazia se não houver faturas

    } catch (error) {
      console.error('Erro ao buscar faturas:', error);
      throw new Error('Não foi possível carregar as faturas.');
    }
  },

  /**
   * Busca um boleto específico em formato Base64.
   * (Método Alternativo: usa /get_boleto)
   */
  async getBoletoAsBase64(idBoleto: string): Promise<string> {
    try {
      // 1. Prepara o corpo da requisição (JSON do seu cURL)
      const requestBody: IXCBoletoRequest = {
        boletos: idBoleto, // O ID da fatura (ex: "223485")
        atualiza_boleto: 'S',
        tipo_boleto: 'arquivo',
        base64: 'S'
      };

      // 2. Chama o 'post' normal (sem o header 'listar')
      const response = await ixcApi.post<IXCBoletoResponse>(
        IXC_CONFIG.ENDPOINTS.GET_BOLETO,
        requestBody
      );

      if (response.file) {
        return response.file; // Retorna a string base64 do PDF
      }

      throw new Error('API não retornou o arquivo do boleto.');

    } catch (error) {
      console.error('Erro ao buscar boleto:', error);
      throw new Error('Não foi possível carregar o boleto.');
    }
  }
};