Tarefa: Mover ConexÃ£o IXC para o Backend (server.js)
Objetivo: Modificar o server.js para que ele atue como um intermediÃ¡rio (proxy) seguro para o IXC. O backend serÃ¡ responsÃ¡vel por:

Receber o login/senha do aplicativo (AplicativoFIber).

Autenticar o usuÃ¡rio usando a "alternativa" do endpoint /cliente (com o Token de Admin).

Criar um Token de SessÃ£o (JWT) para o aplicativo.

Providenciar novos endpoints (ex: /api/invoices) que, usando o JWT, buscarÃ£o os dados no IXC.

Contexto: Isto substitui a necessidade do aplicativo (AplicativoFIber) ter lÃ³gica complexa de API (como em ixcApi.ts). O authService.ts e invoiceService.ts do aplicativo serÃ£o simplificados para chamar apenas o nosso backend.

ModificaÃ§Ãµes no seu backend/server.js
1. Instalar Novas DependÃªncias
Primeiro, precisamos de ferramentas para (A) chamar a API do IXC e (B) criar Tokens JWT.

No seu terminal, na pasta backend (AplicativoFIber/backend), execute:

Bash

npm install axios jsonwebtoken react-native-base64
(Envie o seu package.json e package-lock.json atualizados para o GitHub para o Render os instalar).

2. Adicionar Novas ImportaÃ§Ãµes (no topo)
Adicione estas linhas no topo do seu server.js, junto com as outras:

JavaScript

// Em: backend/server.js

// ... (outros imports)
const GenieACSService = require('./services/genieacs');
const ontRoutes = require('./routes/ont');
const speedTest = require('speedtest-net');
const { GoogleGenerativeAI } = require("@google/generative-ai");

// --- ADICIONE ESTAS LINHAS ---
const axios = require('axios');
const jwt = require('jsonwebtoken');
const base64 = require('react-native-base64'); // Usar o mesmo 'base64' do app
// --- FIM DAS ADIÃ‡Ã•ES ---

const app = express();
// ...
3. Adicionar VariÃ¡veis de Ambiente e o Cliente IXC
Adicione este bloco logo apÃ³s a inicializaÃ§Ã£o do genAI (antes do app.use(helmet())). Isto irÃ¡ configurar a sua conexÃ£o principal com o IXC.

JavaScript

// Em: backend/server.js

// ... (inicializaÃ§Ã£o do genAI)
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || "");

// --- ADICIONE ESTE BLOCO ---
// 1. VariÃ¡veis de Ambiente (Adicione estas ao Render)
const IXC_API_URL = process.env.IXC_API_URL || 'https://centralfiber.online/webservice/v1';
const IXC_ADMIN_TOKEN = process.env.IXC_ADMIN_TOKEN; // O seu "ID:TOKEN" do IXC
const JWT_SECRET = process.env.JWT_SECRET; // Um segredo forte que VOCÃŠ cria (ex: "meu-segredo-de-32-bits")

// 2. Cliente de API para falar com o IXC
const ixcApi = axios.create({
  baseURL: IXC_API_URL,
  headers: {
    'Content-Type': 'application/json',
    // O Token de Admin Ã© o padrÃ£o para TODAS as requisiÃ§Ãµes do backend
    'Authorization': `Basic ${base64.encode(IXC_ADMIN_TOKEN)}`
  },
  timeout: 10000,
});

// 3. FunÃ§Ã£o de Helper (para chamadas 'listar')
const ixcPostList = async (endpoint, data) => {
  const config = { headers: { 'ixcsoft': 'listar' } };
  const response = await ixcApi.post(endpoint, data, config);
  return response.data;
};
// --- FIM DO BLOCO ---

// Middleware de seguranÃ§a
app.use(helmet());
// ...
4. Adicionar a Nova Rota de Login (/api/auth/login)
Adicione esta rota depois do app.use(bodyParser.urlencoded(...)) e antes da rota /api/ont:

JavaScript

// Em: backend/server.js

// ... (Body parser)
app.use(bodyParser.urlencoded({ extended: true }));

// --- ADICIONE ESTA NOVA ROTA DE LOGIN ---
app.post('/api/auth/login', async (req, res, next) => {
  const { login, senha } = req.body;

  if (!login || !senha) {
    return res.status(400).json({ error: 'Login e senha sÃ£o obrigatÃ³rios.' });
  }

  try {
    // --- PASSO 1: PESQUISAR O CLIENTE (A "Alternativa") ---
    const campoBusca = login.includes('@') 
      ? 'cliente.hotsite_email' 
      : 'cliente.cnpj_cpf';

    const searchBody = {
      qtype: campoBusca, query: login, oper: '=',
      page: '1', rp: '1',
      sortname: 'cliente.id', sortorder: 'asc',
    };

    const clienteResponse = await ixcPostList('/cliente', searchBody);

    if (clienteResponse.total === 0 || !clienteResponse.registros[0]) {
      return res.status(401).json({ error: 'UsuÃ¡rio ou senha invÃ¡lidos (C1)' });
    }

    const cliente = clienteResponse.registros[0];

    // --- PASSO 2: VALIDAR A SENHA (No Backend!) ---
    if (cliente.senha !== senha) {
      return res.status(401).json({ error: 'UsuÃ¡rio ou senha invÃ¡lidos (C2)' });
    }

    // --- PASSO 3: BUSCAR O CONTRATO (Chamada Adicional) ---
    const contratoBody = {
      qtype: 'cliente_contrato.id_cliente', query: cliente.id, oper: '=',
      page: '1', rp: '1',
      sortname: 'cliente_contrato.data_ativacao', sortorder: 'desc',
    };

    const contratoResponse = await ixcPostList('/cliente_contrato', contratoBody);
    if (contratoResponse.total === 0 || !contratoResponse.registros[0]) {
      return res.status(404).json({ error: 'Cliente validado, mas nenhum contrato encontrado.' });
    }
    const contrato = contratoResponse.registros[0];

    // --- PASSO 4: CRIAR O NOSSO PRÃ“PRIO TOKEN (JWT) ---
    const userData = {
      id_cliente: cliente.id,
      id_contrato: contrato.id,
      nome_cliente: cliente.razao,
      status_contrato: contrato.status,
    };

    const token = jwt.sign(userData, JWT_SECRET, { expiresIn: '1d' }); // Token vÃ¡lido por 1 dia

    // --- PASSO 5: ENVIAR O TOKEN E OS DADOS PARA O APP ---
    res.json({
      token: token, // O NOSSO token de sessÃ£o
      ...userData // Envia os dados do usuÃ¡rio para o app
    });

  } catch (error) {
    next(error);
  }
});
// --- FIM DA ROTA DE LOGIN ---


// Rotas da API (Existentes)
app.use('/api/ont', ontRoutes);
// ...
5. Adicionar ao Log de InÃ­cio (Para VerificaÃ§Ã£o)
Modifique o seu app.listen para mostrar que as novas variÃ¡veis do IXC foram carregadas:

JavaScript

// Em: backend/server.js
// ... (no final do ficheiro)

// Inicia o servidor
app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                            â•‘
â•‘  ğŸš€ FiberNet Backend API                                   â•‘
â•‘                                                            â•‘
â•‘  Server running on: http://localhost:${PORT}                 â•‘
â•‘  Environment: ${process.env.NODE_ENV || 'development'}                     â•‘
â•‘  GenieACS URL: ${process.env.GENIEACS_URL || 'http://localhost:7557'}   â•‘
â•‘  FiberBot (Gemini): ${process.env.GEMINI_API_KEY ? 'Ativo' : 'Inativo (Sem Chave)'}        â•‘
â•‘  Speedtest: Ativo em /api/speedtest                       â•‘
â•‘  IXC API URL: ${IXC_API_URL}                    â•‘
â•‘  IXC Token: ${IXC_ADMIN_TOKEN ? 'Carregado' : 'NÃƒO CONFIGURADO!'}              â•‘
â•‘  JWT Secret: ${JWT_SECRET ? 'Carregado' : 'NÃƒO CONFIGURADO!'}               â•‘
â•‘                                                            â•‘
â•‘  Ready to manage ONTs! ğŸ“¡                                  â•‘
â•‘                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
});